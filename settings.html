<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Atlas OS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-main: #0a0e1a;
            --bg-surface: #151b2e;
            --bg-elevated: #1e2538;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.5);
            --accent: #3b82f6;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --radius: 12px;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .settings-container {
            display: flex;
            height: 100vh;
            background: var(--bg-main);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-title .material-symbols-rounded {
            font-size: 28px;
            color: var(--accent);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-elevated);
            border-color: var(--border);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
        }

        .nav-item .material-symbols-rounded {
            font-size: 20px;
            color: var(--text-secondary);
        }

        .nav-item.active .material-symbols-rounded {
            color: white;
        }

        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .content-header {
            margin-bottom: 32px;
        }

        .content-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .content-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Settings Sections */
        .settings-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title .material-symbols-rounded {
            font-size: 22px;
            color: var(--accent);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border);
        }

        .toggle.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle.active::after {
            left: 22px;
        }

        /* Input Fields */
        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
            font-family: inherit;
        }

        .input-field:focus {
            border-color: var(--accent);
            background: var(--bg-main);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        textarea.input-field {
            resize: vertical;
            min-height: 100px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #059669;
            border-color: #059669;
        }

        /* App Installation */
        .app-form {
            display: grid;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .icon-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .icon-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .icon-option:hover {
            background: var(--bg-main);
            border-color: var(--border);
        }

        .icon-option.selected {
            background: var(--accent);
            border-color: var(--accent);
        }

        .icon-option .material-symbols-rounded {
            font-size: 32px;
            color: var(--accent);
        }

        .icon-option.selected .material-symbols-rounded {
            color: white;
        }

        .icon-option-name {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .icon-option.selected .icon-option-name {
            color: white;
        }

        /* App List */
        .app-list {
            display: grid;
            gap: 12px;
        }

        .app-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .app-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .app-card-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            flex-shrink: 0;
        }

        .app-card-icon .material-symbols-rounded {
            font-size: 32px;
            color: var(--accent);
        }

        .app-card-info {
            flex: 1;
        }

        .app-card-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .app-card-type {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .app-card-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .icon-btn:hover {
            background: var(--bg-main);
            border-color: var(--accent);
            color: var(--accent);
        }

        .icon-btn.danger:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            gap: 12px;
        }

        .radio-option {
            flex: 1;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .radio-option:hover {
            border-color: var(--accent);
        }

        .radio-option.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast .material-symbols-rounded {
            font-size: 24px;
        }

        .toast.success .material-symbols-rounded {
            color: var(--success);
        }

        .toast.error .material-symbols-rounded {
            color: var(--danger);
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .material-symbols-rounded {
            font-size: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .color-picker-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            background: var(--bg-elevated);
        }

        .color-preview {
            flex: 1;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <span class="material-symbols-rounded">settings</span>
                    Settings
                </div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <div class="nav-item active" data-page="apps">
                        <span class="material-symbols-rounded">apps</span>
                        <span class="nav-item-text">Applications</span>
                    </div>
                    <div class="nav-item" data-page="appearance">
                        <span class="material-symbols-rounded">palette</span>
                        <span class="nav-item-text">Appearance</span>
                    </div>
                    <div class="nav-item" data-page="notifications">
                        <span class="material-symbols-rounded">notifications</span>
                        <span class="nav-item-text">Notifications</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Advanced</div>
                    <div class="nav-item" data-page="storage">
                        <span class="material-symbols-rounded">storage</span>
                        <span class="nav-item-text">Storage</span>
                    </div>
                    <div class="nav-item" data-page="about">
                        <span class="material-symbols-rounded">info</span>
                        <span class="nav-item-text">About</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Applications Page -->
            <div class="tab-content active" id="page-apps">
                <div class="content-header">
                    <div class="content-title">Applications</div>
                    <div class="content-description">Manage and install applications on Atlas OS</div>
                </div>

                <!-- Install App Section -->
                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">add_circle</span>
                        Install New Application
                    </div>
                    <div class="app-form">
                        <div class="form-group">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="input-field" id="appName" placeholder="My App">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Application Icon</label>
                            <input type="text" class="input-field" id="appIconSearch" placeholder="Search icons...">
                            <div class="icon-picker" id="iconPicker"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Application Type</label>
                            <div class="radio-group">
                                <div class="radio-option selected" data-type="url">
                                    <div style="font-weight: 600; margin-bottom: 4px;">URL</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">External website</div>
                                </div>
                                <div class="radio-option" data-type="html">
                                    <div style="font-weight: 600; margin-bottom: 4px;">HTML</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Custom code</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="urlGroup">
                            <label class="form-label">Application URL</label>
                            <input type="text" class="input-field" id="appUrl" placeholder="https://example.com">
                        </div>
                        <div class="form-group" id="htmlGroup" style="display: none;">
                            <label class="form-label">HTML Code</label>
                            <textarea class="input-field" id="appHtml" placeholder="<!DOCTYPE html>...</textarea>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-primary" id="installApp">
                                <span class="material-symbols-rounded">download</span>
                                Install Application
                            </button>
                            <button class="btn btn-secondary" id="clearForm">
                                <span class="material-symbols-rounded">clear</span>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Installed Apps Section -->
                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">inventory_2</span>
                        Installed Applications
                    </div>
                    <div class="app-list" id="installedApps"></div>
                </div>
            </div>

            <!-- Appearance Page -->
            <div class="tab-content" id="page-appearance">
                <div class="content-header">
                    <div class="content-title">Appearance</div>
                    <div class="content-description">Customize the look and feel of Atlas OS</div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">wallpaper</span>
                        Desktop Wallpaper
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Wallpaper URL</div>
                            <div class="setting-desc">Enter a URL to an image to use as wallpaper</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <input type="text" class="input-field" id="wallpaperUrl" placeholder="https://example.com/wallpaper.jpg" style="flex: 1;">
                        <button class="btn btn-primary" id="setWallpaper">
                            <span class="material-symbols-rounded">image</span>
                            Set Wallpaper
                        </button>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">format_paint</span>
                        Theme Colors
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Accent Color</div>
                            <div class="setting-desc">Primary color used throughout the system</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <div class="color-picker-wrapper">
                            <input type="color" id="accentColor" value="#3b82f6">
                            <div class="color-preview" id="accentPreview">#3b82f6</div>
                            <button class="btn btn-primary" id="setAccentColor">Apply</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Page -->
            <div class="tab-content" id="page-notifications">
                <div class="content-header">
                    <div class="content-title">Notifications</div>
                    <div class="content-description">Manage system notifications</div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">notifications</span>
                        Notification Settings
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Enable Notifications</div>
                            <div class="setting-desc">Show desktop notifications from apps</div>
                        </div>
                        <div class="toggle active" data-setting="notifications-enabled"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Notification Sounds</div>
                            <div class="setting-desc">Play sounds when notifications arrive</div>
                        </div>
                        <div class="toggle" data-setting="notification-sounds"></div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">send</span>
                        Test Notification
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 14px;">
                        Send a test notification to see how they appear in the system
                    </p>
                    <button class="btn btn-primary" id="sendTestNotification">
                        <span class="material-symbols-rounded">notification_add</span>
                        Send Test Notification
                    </button>
                </div>
            </div>

            <!-- Storage Page -->
            <div class="tab-content" id="page-storage">
                <div class="content-header">
                    <div class="content-title">Storage</div>
                    <div class="content-description">Manage IndexedDB storage and data</div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">database</span>
                        Database Information
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Database Name</div>
                            <div class="setting-desc">AtlasDB</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Database Version</div>
                            <div class="setting-desc">1</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Total Applications</div>
                            <div class="setting-desc" id="totalApps">0</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Total Notifications</div>
                            <div class="setting-desc" id="totalNotifications">0</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">warning</span>
                        Danger Zone
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Clear All Data</div>
                            <div class="setting-desc">This will remove all apps, notifications, and settings</div>
                        </div>
                        <button class="btn btn-danger" id="clearAllData">
                            <span class="material-symbols-rounded">delete_forever</span>
                            Clear Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- About Page -->
            <div class="tab-content" id="page-about">
                <div class="content-header">
                    <div class="content-title">About Atlas OS</div>
                    <div class="content-description">System information and details</div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">info</span>
                        System Information
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Operating System</div>
                            <div class="setting-desc">Atlas OS</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Version</div>
                            <div class="setting-desc">1.0.0</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Platform</div>
                            <div class="setting-desc">Web (HTML, CSS, JavaScript)</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Storage</div>
                            <div class="setting-desc">IndexedDB (AtlasDB v1)</div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">Icons</div>
                            <div class="setting-desc">Google Material Symbols (Rounded)</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="section-title">
                        <span class="material-symbols-rounded">code</span>
                        Technologies
                    </div>
                    <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                        Atlas OS is built with modern web technologies including HTML5, CSS3, and vanilla JavaScript.
                        It uses IndexedDB for persistent storage and Material Symbols for icons.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // IndexedDB Setup
        let db;
        const DB_NAME = 'AtlasDB';
        const DB_VERSION = 1;

        // Common Material Icons
        const COMMON_ICONS = [
            'apps', 'settings', 'folder', 'description', 'image', 'music_note',
            'videocam', 'calendar_month', 'mail', 'phone', 'message', 'chat',
            'terminal', 'code', 'bug_report', 'calculate', 'draw', 'palette',
            'movie', 'sports_esports', 'headphones', 'camera', 'photo_library',
            'cloud', 'download', 'upload', 'share', 'favorite', 'star',
            'bookmark', 'shopping_cart', 'store', 'attach_money', 'account_circle',
            'group', 'location_on', 'map', 'directions_car', 'flight', 'hotel'
        ];

        let selectedIcon = 'apps';
        let selectedType = 'url';

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('apps')) {
                        db.createObjectStore('apps', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('notifications')) {
                        db.createObjectStore('notifications', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('appexecute')) {
                        db.createObjectStore('appexecute', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        const settingsStore = db.createObjectStore('settings', { keyPath: 'key' });
                        settingsStore.add({ key: 'wallpaper', value: '' });
                        settingsStore.add({ key: 'theme', value: 'dark' });
                        settingsStore.add({ key: 'accentColor', value: '#3b82f6' });
                        settingsStore.add({ key: 'notifications-enabled', value: true });
                        settingsStore.add({ key: 'notification-sounds', value: false });
                    }
                    if (!db.objectStoreNames.contains('desktop')) {
                        db.createObjectStore('desktop', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // Database operations
        async function addApp(app) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['apps'], 'readwrite');
                const store = transaction.objectStore('apps');
                const request = store.add(app);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllApps() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['apps'], 'readonly');
                const store = transaction.objectStore('apps');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteApp(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['apps'], 'readwrite');
                const store = transaction.objectStore('apps');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getSetting(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readonly');
                const store = transaction.objectStore('settings');
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => reject(request.error);
            });
        }

        async function setSetting(key, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                const request = store.put({ key, value });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function addNotification(notification) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['notifications'], 'readwrite');
                const store = transaction.objectStore('notifications');
                const request = store.add(notification);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllNotifications() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['notifications'], 'readonly');
                const store = transaction.objectStore('notifications');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function clearAllStores() {
            const stores = ['apps', 'notifications', 'appexecute', 'desktop'];
            for (const storeName of stores) {
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        async function addAppExecuteCommand(code) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['appexecute'], 'readwrite');
                const store = transaction.objectStore('appexecute');
                const request = store.add({ code, timestamp: Date.now() });
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // UI Functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="material-symbols-rounded">${type === 'success' ? 'check_circle' : 'error'}</span>
                <div class="toast-message">${message}</div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function renderIconPicker(filter = '') {
            const picker = document.getElementById('iconPicker');
            picker.innerHTML = '';
            
            const filtered = filter 
                ? COMMON_ICONS.filter(icon => icon.includes(filter.toLowerCase()))
                : COMMON_ICONS;

            filtered.forEach(icon => {
                const option = document.createElement('div');
                option.className = `icon-option ${icon === selectedIcon ? 'selected' : ''}`;
                option.innerHTML = `
                    <span class="material-symbols-rounded">${icon}</span>
                    <div class="icon-option-name">${icon}</div>
                `;
                option.addEventListener('click', () => {
                    document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedIcon = icon;
                });
                picker.appendChild(option);
            });
        }

        async function renderInstalledApps() {
            const apps = await getAllApps();
            const container = document.getElementById('installedApps');

            if (apps.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-rounded">inventory_2</span>
                        <div class="empty-state-text">No applications installed</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Install your first app using the form above</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            apps.forEach(app => {
                const card = document.createElement('div');
                card.className = 'app-card';
                card.innerHTML = `
                    <div class="app-card-icon">
                        <span class="material-symbols-rounded">${app.icon || 'apps'}</span>
                    </div>
                    <div class="app-card-info">
                        <div class="app-card-name">${app.name}</div>
                        <div class="app-card-type">${app.url ? `URL: ${app.url}` : 'Custom HTML'}</div>
                    </div>
                    <div class="app-card-actions">
                        <button class="icon-btn danger" onclick="uninstallApp(${app.id})">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function uninstallApp(id) {
            if (confirm('Are you sure you want to uninstall this application?')) {
                try {
                    await deleteApp(id);
                    await renderInstalledApps();
                    await updateStorageStats();
                    
                    // Notify launcher to refresh
                    await addAppExecuteCommand('location.reload()');
                    
                    showToast('Application uninstalled successfully');
                } catch (error) {
                    showToast('Failed to uninstall application', 'error');
                    console.error(error);
                }
            }
        }

        async function updateStorageStats() {
            const apps = await getAllApps();
            const notifications = await getAllNotifications();
            
            document.getElementById('totalApps').textContent = apps.length;
            document.getElementById('totalNotifications').textContent = notifications.length;
        }

        // Event Listeners
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');
            });
        });

        document.querySelectorAll('.radio-option').forEach(option => {
            option.addEventListener('click', () => {
                const type = option.dataset.type;
                document.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedType = type;
                
                if (type === 'url') {
                    document.getElementById('urlGroup').style.display = 'flex';
                    document.getElementById('htmlGroup').style.display = 'none';
                } else {
                    document.getElementById('urlGroup').style.display = 'none';
                    document.getElementById('htmlGroup').style.display = 'flex';
                }
            });
        });

        document.getElementById('appIconSearch').addEventListener('input', (e) => {
            renderIconPicker(e.target.value);
        });

        document.getElementById('installApp').addEventListener('click', async () => {
            const name = document.getElementById('appName').value.trim();
            const url = document.getElementById('appUrl').value.trim();
            const html = document.getElementById('appHtml').value.trim();

            if (!name) {
                showToast('Please enter an application name', 'error');
                return;
            }

            if (selectedType === 'url' && !url) {
                showToast('Please enter an application URL', 'error');
                return;
            }

            if (selectedType === 'html' && !html) {
                showToast('Please enter HTML code', 'error');
                return;
            }

            try {
                const app = {
                    name,
                    icon: selectedIcon,
                    ...(selectedType === 'url' ? { url } : { html })
                };

                await addApp(app);
                await renderInstalledApps();
                await updateStorageStats();
                
                // Notify launcher to refresh
                await addAppExecuteCommand('location.reload()');
                
                showToast(`${name} installed successfully`);
                document.getElementById('clearForm').click();
            } catch (error) {
                showToast('Failed to install application', 'error');
                console.error(error);
            }
        });

        document.getElementById('clearForm').addEventListener('click', () => {
            document.getElementById('appName').value = '';
            document.getElementById('appUrl').value = '';
            document.getElementById('appHtml').value = '';
            document.getElementById('appIconSearch').value = '';
            selectedIcon = 'apps';
            renderIconPicker();
        });

        document.getElementById('setWallpaper').addEventListener('click', async () => {
            const url = document.getElementById('wallpaperUrl').value.trim();
            if (!url) {
                showToast('Please enter a wallpaper URL', 'error');
                return;
            }

            try {
                await setSetting('wallpaper', url);
                
                // Notify launcher to update wallpaper
                const code = `
                    (async () => {
                        const wallpaper = await getSetting('wallpaper');
                        if (wallpaper) {
                            document.querySelector('.desktop').style.backgroundImage = \`url(\${wallpaper})\`;
                            document.querySelector('.desktop').style.backgroundSize = 'cover';
                            document.querySelector('.desktop').style.backgroundPosition = 'center';
                        }
                    })();
                `;
                await addAppExecuteCommand(code);
                
                showToast('Wallpaper updated successfully');
            } catch (error) {
                showToast('Failed to update wallpaper', 'error');
                console.error(error);
            }
        });

        document.getElementById('accentColor').addEventListener('input', (e) => {
            document.getElementById('accentPreview').textContent = e.target.value;
        });

        document.getElementById('setAccentColor').addEventListener('click', async () => {
            const color = document.getElementById('accentColor').value;
            
            try {
                await setSetting('accentColor', color);
                
                // Notify launcher to update accent color
                const code = `
                    (async () => {
                        const color = await getSetting('accentColor');
                        if (color) {
                            document.documentElement.style.setProperty('--accent', color);
                            document.documentElement.style.setProperty('--primary', color);
                        }
                    })();
                `;
                await addAppExecuteCommand(code);
                
                // Update local accent
                document.documentElement.style.setProperty('--accent', color);
                document.documentElement.style.setProperty('--primary', color);
                
                showToast('Accent color updated successfully');
            } catch (error) {
                showToast('Failed to update accent color', 'error');
                console.error(error);
            }
        });

        document.querySelectorAll('.toggle').forEach(toggle => {
            toggle.addEventListener('click', async () => {
                const setting = toggle.dataset.setting;
                const isActive = toggle.classList.contains('active');
                const newValue = !isActive;
                
                toggle.classList.toggle('active');
                
                try {
                    await setSetting(setting, newValue);
                    showToast(`Setting ${newValue ? 'enabled' : 'disabled'}`);
                } catch (error) {
                    showToast('Failed to update setting', 'error');
                    toggle.classList.toggle('active');
                }
            });
        });

        document.getElementById('sendTestNotification').addEventListener('click', async () => {
            try {
                await addNotification({
                    app: 'Settings',
                    content: 'This is a test notification from Atlas OS Settings',
                    time: new Date().toISOString()
                });
                showToast('Test notification sent');
            } catch (error) {
                showToast('Failed to send notification', 'error');
                console.error(error);
            }
        });

        document.getElementById('clearAllData').addEventListener('click', async () => {
            if (confirm('Are you sure? This will delete ALL data including apps, notifications, and settings. This action cannot be undone.')) {
                if (confirm('Really sure? This is your last chance to cancel.')) {
                    try {
                        await clearAllStores();
                        showToast('All data cleared successfully');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } catch (error) {
                        showToast('Failed to clear data', 'error');
                        console.error(error);
                    }
                }
            }
        });

        // Initialize
        async function init() {
            await initDB();
            renderIconPicker();
            await renderInstalledApps();
            await updateStorageStats();
            
            // Load saved settings
            const accentColor = await getSetting('accentColor');
            if (accentColor) {
                document.getElementById('accentColor').value = accentColor;
                document.getElementById('accentPreview').textContent = accentColor;
                document.documentElement.style.setProperty('--accent', accentColor);
                document.documentElement.style.setProperty('--primary', accentColor);
            }

            const wallpaper = await getSetting('wallpaper');
            if (wallpaper) {
                document.getElementById('wallpaperUrl').value = wallpaper;
            }

            // Load toggle states
            const notifEnabled = await getSetting('notifications-enabled');
            const notifSounds = await getSetting('notification-sounds');
            
            document.querySelector('[data-setting="notifications-enabled"]').classList.toggle('active', notifEnabled !== false);
            document.querySelector('[data-setting="notification-sounds"]').classList.toggle('active', notifSounds === true);
        }

        init();
    </script>
</body>
</html>
