<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            overscroll-behavior: none;
            touch-action: none;
        }
        
        .marker-scroll::-webkit-scrollbar { height: 6px; }
        .marker-scroll::-webkit-scrollbar-track { background: transparent; }
        .marker-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        .marker-item {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }
        
        .marker-item.active {
            transform: translateY(-20px) scale(1.15);
            z-index: 10;
            filter: drop-shadow(0 15px 12px rgb(0 0 0 / 0.2));
        }

        .marker-item:not(.active):hover {
            transform: translateY(-4px);
        }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #3b82f6; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px;
        }
        
        .canvas-bg {
            background-color: #ffffff;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
        }

        #toast {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
    </style>
</head>
<body class="canvas-bg h-screen w-screen overflow-hidden flex flex-col font-sans text-slate-700">

    <!-- Top Bar -->
    <div class="fixed top-4 left-4 right-4 z-50 flex justify-between items-start pointer-events-none">
        <!-- History Controls -->
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="undo()" id="btn-undo" class="bg-white p-3 rounded-full shadow-lg hover:bg-slate-50 text-slate-400 transition-colors border border-slate-100 disabled:opacity-30" title="Undo">
                <i data-lucide="undo-2" class="w-5 h-5"></i>
            </button>
            <button onclick="redo()" id="btn-redo" class="bg-white p-3 rounded-full shadow-lg hover:bg-slate-50 text-slate-400 transition-colors border border-slate-100 disabled:opacity-30" title="Redo">
                <i data-lucide="redo-2" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Action Controls -->
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="clearCanvas()" class="bg-white p-3 rounded-full shadow-lg hover:bg-red-50 text-red-500 transition-colors border border-slate-100 group">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
            <button onclick="downloadCanvas()" class="bg-slate-800 p-3 rounded-full shadow-lg hover:bg-slate-700 text-white transition-colors border border-slate-700 group">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] bg-slate-900 text-white px-6 py-2 rounded-full text-sm font-medium shadow-xl opacity-0 pointer-events-none transform -translate-y-4">
        Notification message
    </div>

    <!-- Size Popover -->
    <div id="size-popover" class="fixed bottom-40 left-1/2 -translate-x-1/2 bg-white px-6 py-4 rounded-2xl shadow-2xl border border-slate-100 z-40 w-64 opacity-0 pointer-events-none transition-all duration-200 transform translate-y-4">
        <div class="flex justify-between items-center mb-3">
            <span class="text-xs font-bold text-slate-400 uppercase">Tool Size</span>
            <span id="size-display" class="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-0.5 rounded">5px</span>
        </div>
        <input type="range" id="tool-size" min="1" max="100" value="5" oninput="updateSizePreview(this.value)">
        <div class="mt-4 h-16 flex items-center justify-center border-t border-slate-50 pt-2">
            <div id="size-preview" class="rounded-full bg-slate-800 transition-all duration-75"></div>
        </div>
    </div>

    <!-- Custom Color Modal -->
    <div id="color-modal" class="fixed inset-0 z-[60] flex items-center justify-center modal-overlay opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-80 transform transition-transform duration-300 scale-90" id="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800">Choose Custom Color</h3>
                <button onclick="closeColorModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="relative w-full h-32 rounded-xl overflow-hidden cursor-crosshair border border-slate-100">
                    <input type="color" id="main-picker" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" oninput="syncColorInput(this.value)">
                    <div id="picker-preview" class="w-full h-full bg-slate-800 flex items-center justify-center text-white font-bold text-xs shadow-inner">
                        Click to Open System Picker
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-slate-400 font-mono text-lg">#</span>
                    <input type="text" id="hex-input" maxlength="6" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 font-mono uppercase outline-none" placeholder="FFFFFF" oninput="syncHexInput(this.value)">
                </div>
                <button onclick="applyCustomColor()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-700 transition-colors shadow-lg">
                    Apply Color
                </button>
            </div>
        </div>
    </div>

    <canvas id="drawing-canvas" class="block touch-none"></canvas>

    <!-- Bottom Toolbar -->
    <div class="fixed bottom-0 w-full z-30">
        <div class="absolute bottom-0 left-0 w-full h-36 bg-gradient-to-t from-white via-white/95 to-transparent pointer-events-none"></div>
        <div class="relative w-full overflow-x-auto marker-scroll pb-4 px-4 flex items-end gap-2 pt-12" id="tool-rack">
            <div class="marker-item flex-shrink-0 group relative" onclick="selectTool('eraser', '#ffffff', this)" id="btn-eraser">
                <div class="w-14 h-32 relative">
                    <svg viewBox="0 0 60 140" class="w-full h-full drop-shadow-md" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 10,40 L 10,10 Q 10,0 20,0 L 40,0 Q 50,0 50,10 L 50,40" fill="#fca5a5" stroke="#1e293b" stroke-width="2.5" />
                        <rect x="10" y="40" width="40" height="25" fill="#e2e8f0" stroke="#1e293b" stroke-width="2.5" />
                        <path d="M 10,65 L 10,130 Q 10,138 18,138 L 42,138 Q 50,138 50,130 L 50,65 Z" fill="#fcd34d" stroke="#1e293b" stroke-width="2.5" />
                    </svg>
                </div>
            </div>
            <div class="w-px h-16 bg-slate-200 mx-1 mb-8 flex-shrink-0"></div>
            <div id="marker-list" class="flex items-end gap-1"></div>
            <div class="marker-item flex-shrink-0 relative ml-2" onclick="handlePlusClick(this)" id="btn-custom">
                <div class="w-14 h-32 relative">
                    <svg id="plus-marker-svg" viewBox="0 0 100 240" class="w-full h-full drop-shadow-md" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 25,70 L 25,180 Q 25,190 35,190 L 65,190 Q 75,190 75,180 L 75,70 Z" fill="#ffffff" stroke="#1e293b" stroke-width="3"/>
                        <path id="plus-base" d="M 25,180 L 25,200 Q 25,215 50,215 Q 75,215 75,200 L 75,180 Z" fill="#f1f5f9" stroke="#1e293b" stroke-width="3"/>
                        <path d="M 25,70 L 75,70 L 70,55 L 30,55 Z" fill="#cbd5e1" stroke="#1e293b" stroke-width="3"/>
                        <path id="plus-tip" d="M 30,55 L 50,10 L 70,55 Z" fill="#ffffff" stroke="#1e293b" stroke-width="3"/>
                        <g id="plus-icon">
                            <line x1="50" y1="110" x2="50" y2="150" stroke="#cbd5e1" stroke-width="6" stroke-linecap="round"/>
                            <line x1="30" y1="130" x2="70" y2="130" stroke="#cbd5e1" stroke-width="6" stroke-linecap="round"/>
                        </g>
                    </svg>
                </div>
            </div>
            <div class="w-8 flex-shrink-0"></div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const MAIN_COLORS = ['#1e293b', '#ef4444', '#3b82f6', '#22c55e', '#eab308'];
        const EXTRA_COLORS = ['#f97316', '#a855f7', '#ec4899', '#06b6d4', '#84cc16', '#6366f1', '#14b8a6', '#f43f5e', '#d946ef', '#8b5cf6', '#334155', '#475569', '#64748b', '#94a3b8', '#78350f', '#713f12', '#451a03', '#1e1b4b', '#134e4a', '#fbbf24', '#c084fc', '#818cf8', '#2dd4bf', '#fb7185', '#9ca3af'];

        let currentTool = 'marker';
        let currentColor = MAIN_COLORS[0];
        let markerSize = 5;
        let eraserSize = 25;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let activeBtn = null;
        let pendingCustomColor = '#3b82f6';

        // Undo/Redo State
        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY = 50;

        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const markerList = document.getElementById('marker-list');
        const sizePopover = document.getElementById('size-popover');
        const toolSizeInput = document.getElementById('tool-size');
        const sizePreview = document.getElementById('size-preview');
        const sizeDisplay = document.getElementById('size-display');
        const colorModal = document.getElementById('color-modal');
        const modalContent = document.getElementById('modal-content');
        const hexInput = document.getElementById('hex-input');
        const pickerPreview = document.getElementById('picker-preview');
        const toast = document.getElementById('toast');

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            loadDrawing();
            generateMarkers();

            setTimeout(() => {
                const firstMarker = markerList.children[0];
                if(firstMarker) selectTool('marker', MAIN_COLORS[0], firstMarker);
            }, 50);

            canvas.addEventListener('pointerdown', startDrawing);
            canvas.addEventListener('pointermove', draw);
            canvas.addEventListener('pointerup', stopDrawing);
            canvas.addEventListener('pointerout', stopDrawing);
            
            updateHistoryButtons();
        }

        // --- Notification Logic ---
        function setNotificationHash(message) {
            window.location.hash = `notification=${encodeURIComponent(message)}`;
            showToast(message);
        }

        function showToast(message) {
            toast.innerText = message;
            toast.classList.remove('opacity-0', '-translate-y-4', 'pointer-events-none');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4', 'pointer-events-none');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        }

        // --- History Logic ---
        function pushState() {
            undoStack.push(canvas.toDataURL());
            if (undoStack.length > MAX_HISTORY) undoStack.shift();
            redoStack = []; // Clear redo on new action
            updateHistoryButtons();
        }

        function undo() {
            if (undoStack.length === 0) return;
            redoStack.push(canvas.toDataURL());
            const previous = undoStack.pop();
            renderState(previous);
            updateHistoryButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            undoStack.push(canvas.toDataURL());
            const next = redoStack.pop();
            renderState(next);
            updateHistoryButtons();
        }

        function renderState(dataUrl) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!dataUrl) return;
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                saveDrawing();
            };
            img.src = dataUrl;
        }

        function updateHistoryButtons() {
            document.getElementById('btn-undo').disabled = undoStack.length === 0;
            document.getElementById('btn-redo').disabled = redoStack.length === 0;
            document.getElementById('btn-undo').classList.toggle('text-slate-800', undoStack.length > 0);
            document.getElementById('btn-redo').classList.toggle('text-slate-800', redoStack.length > 0);
        }

        // --- UI & Markers ---
        function getMarkerSVG(color) {
            const cleanId = color.replace('#','');
            return `
            <svg viewBox="0 0 100 240" class="w-full h-full drop-shadow-md pointer-events-none" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="grad-${cleanId}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#f1f5f9"/><stop offset="50%" style="stop-color:#ffffff"/><stop offset="100%" style="stop-color:#e2e8f0"/></linearGradient></defs>
                <path d="M 25,70 L 25,180 Q 25,190 35,190 L 65,190 Q 75,190 75,180 L 75,70 Z" fill="url(#grad-${cleanId})" stroke="#1e293b" stroke-width="3"/>
                <path d="M 25,180 L 25,200 Q 25,215 50,215 Q 75,215 75,200 L 75,180 Z" fill="${color}" stroke="#1e293b" stroke-width="3"/>
                <path d="M 25,70 L 75,70 L 70,55 L 30,55 Z" fill="#cbd5e1" stroke="#1e293b" stroke-width="3"/>
                <path d="M 30,55 L 50,10 L 70,55 Z" fill="${color}" stroke="#1e293b" stroke-width="3"/>
            </svg>`;
        }

        function generateMarkers() {
            [...MAIN_COLORS, ...EXTRA_COLORS].forEach((color, idx) => {
                if (idx === MAIN_COLORS.length) {
                    const div = document.createElement('div');
                    div.className = "w-px h-12 bg-slate-200 mx-2 mb-8 flex-shrink-0";
                    markerList.appendChild(div);
                }
                const btn = document.createElement('div');
                btn.className = 'marker-item flex-shrink-0 w-14 h-32 relative';
                btn.innerHTML = getMarkerSVG(color);
                btn.onclick = () => selectTool('marker', color, btn);
                markerList.appendChild(btn);
            });
        }

        function selectTool(tool, color, btnElement) {
            if (activeBtn === btnElement) return toggleSizePopover();
            hideSizePopover();
            if (activeBtn) activeBtn.classList.remove('active');
            activeBtn = btnElement;
            activeBtn.classList.add('active');
            currentTool = tool;
            currentColor = color;
        }

        function handlePlusClick(btn) {
            if (activeBtn === btn) openColorModal();
            else { selectTool('marker', pendingCustomColor, btn); openColorModal(); }
        }

        function openColorModal() {
            colorModal.classList.remove('opacity-0', 'pointer-events-none');
            modalContent.classList.add('scale-100');
            syncColorInput(pendingCustomColor);
        }

        function closeColorModal() {
            colorModal.classList.add('opacity-0', 'pointer-events-none');
            modalContent.classList.remove('scale-100');
        }

        function syncColorInput(color) {
            pendingCustomColor = color;
            pickerPreview.style.backgroundColor = color;
            hexInput.value = color.replace('#', '').toUpperCase();
            const r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16);
            pickerPreview.style.color = (r*0.299 + g*0.587 + b*0.114) > 186 ? '#1e293b' : '#ffffff';
        }

        function syncHexInput(val) {
            if (val.length === 6) { syncColorInput('#' + val); document.getElementById('main-picker').value = '#' + val; }
        }

        function applyCustomColor() {
            currentColor = pendingCustomColor;
            document.getElementById('plus-tip').setAttribute('fill', currentColor);
            document.getElementById('plus-base').setAttribute('fill', currentColor);
            document.getElementById('plus-icon').style.display = 'none';
            closeColorModal();
        }

        function toggleSizePopover() { sizePopover.classList.contains('opacity-100') ? hideSizePopover() : showSizePopover(); }
        function showSizePopover() {
            sizePopover.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            sizePopover.classList.add('opacity-100', 'translate-y-0');
            const size = currentTool === 'marker' ? markerSize : eraserSize;
            toolSizeInput.value = size;
            updateSizePreview(size);
        }

        function hideSizePopover() { sizePopover.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4'); sizePopover.classList.remove('opacity-100', 'translate-y-0'); }
        function updateSizePreview(val) {
            val = parseInt(val); sizeDisplay.innerText = val + 'px';
            if (currentTool === 'marker') markerSize = val; else eraserSize = val;
            sizePreview.style.width = val + 'px'; sizePreview.style.height = val + 'px';
            sizePreview.style.backgroundColor = currentTool === 'marker' ? currentColor : '#fca5a5';
        }

        // --- Drawing Core ---
        function startDrawing(e) {
            hideSizePopover();
            pushState(); // Save state before action
            isDrawing = true;
            const { x, y } = getCoords(e);
            lastX = x; lastY = y;
            draw(e, true);
        }

        function draw(e, isDot = false) {
            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getCoords(e);
            ctx.beginPath();
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = eraserSize;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = markerSize;
            }
            ctx.moveTo(lastX, lastY);
            isDot ? ctx.lineTo(x + 0.1, y + 0.1) : ctx.lineTo(x, y);
            ctx.stroke();
            lastX = x; lastY = y;
        }

        function stopDrawing() { if (isDrawing) { isDrawing = false; saveDrawing(); } }
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: (e.clientX || e.touches?.[0].clientX) - rect.left, y: (e.clientY || e.touches?.[0].clientY) - rect.top };
        }

        function resizeCanvas() {
            const data = canvas.toDataURL();
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = data;
        }

        function clearCanvas() {
            if(confirm('Clear drawing?')) {
                pushState();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                saveDrawing();
                setNotificationHash("Your canvas has been cleared.");
            }
        }

        function downloadCanvas() {
            const temp = document.createElement('canvas');
            temp.width = canvas.width; temp.height = canvas.height;
            const tCtx = temp.getContext('2d');
            tCtx.fillStyle = '#fff'; tCtx.fillRect(0,0,temp.width,temp.height);
            tCtx.drawImage(canvas, 0, 0);
            const a = document.createElement('a');
            a.download = `art-${Date.now()}.png`; a.href = temp.toDataURL(); a.click();
            setNotificationHash("Your canvas has been exported.");
        }

        function saveDrawing() { localStorage.setItem('art-save', canvas.toDataURL()); }
        function loadDrawing() { 
            const d = localStorage.getItem('art-save');
            if(d) { const i = new Image(); i.onload = () => ctx.drawImage(i, 0, 0); i.src = d; }
        }

        init();
    </script>
</body>
</html>
